<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scopri la sequenza</title>
<style>
  :root{ --cell-size:60px; --gap:8px; --bg:#f3f3f3; --cell-border:#aaa; }
  body{
    font-family: Arial, sans-serif;
    margin:0;
    background:var(--bg);
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    padding-bottom:80px; /* spazio per footer fisso */
  }
  #topBanner{
    width:100%;
    background:#ccc;
    text-align:center;
    padding:10px 0;
    box-shadow:0 2px 5px rgba(0,0,0,0.12);
  }
  h1{ margin:14px 0; }
  #levelIndicator{ margin-bottom:10px; font-size:18px; }
  #grid{
    display:grid;
    gap:var(--gap);
    margin-bottom:12px;
  }
  .cell{
    width:var(--cell-size);
    height:var(--cell-size);
    border:2px solid var(--cell-border);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:24px;
    background:white;
    box-sizing:border-box;
    user-select:none;
  }
  .cell.active{ border:3px solid #000; }
  .cell.disabled{ opacity:0.6; }
  #keypad{
    margin-top:6px;
    display:grid;
    grid-template-columns:repeat(3,60px);
    gap:10px;
    justify-content:center;
  }
  .key{
    width:60px;
    height:48px;
    font-size:20px;
    border-radius:6px;
    border:1px solid #bbb;
    background:white;
    cursor:pointer;
    user-select:none;
  }
  .key:active{ transform:translateY(1px); }
  #delKey{ background:#d54d4d; color:white; grid-column:span 2; }
  #result{ margin-top:12px; min-height:36px; }
  #statsBox{
    display:none;
    margin-top:14px;
    padding:12px;
    background:#fff;
    border:1px solid #ddd;
    border-radius:6px;
    text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.06);
  }
  #bottomBanner{
    width:100%;
    background:#ccc;
    text-align:center;
    padding:10px 0;
    box-shadow:0 -2px 5px rgba(0,0,0,0.12);
    position:fixed;
    bottom:0;
    left:0;
  }
  /* disabilita selezione testo del body per tocco pi√π pulito */
  body, button { -webkit-tap-highlight-color: transparent; }
</style>
</head>
<body>
  <div id="topBanner">BannerUp</div>
  <h1>Scopri la sequenza</h1>
  <div id="levelIndicator"></div>
  <div id="grid"></div>

<!-- Tastierino numerico -->
<div id="keypad" style="display:grid;grid-template-columns:repeat(5,60px);gap:8px;margin-top:20px;">
<button class="key">0</button>
<button class="key">1</button>
<button class="key">2</button>
<button class="key">3</button>
<button class="key">4</button>
<button class="key">5</button>
<button class="key">6</button>
<button class="key">7</button>
<button class="key">8</button>
<button class="key">9</button>
<button id="delKey" class="key" style="grid-column: span 2; background:#d9534f; color:white;">‚Üê</button>
<button id="enterKey" class="key" style="grid-column: span 3; background:#5cb85c; color:white; font-weight:bold;">INVIO</button>
</div>

  <div id="result"></div>

  <div id="statsBox">
    <div id="statsSummary"></div>
  </div>

  <div id="bottomBanner">BannerFooter</div>

<script>
/* ---------------- CONFIG ---------------- */
const maxPartiteGiornaliere = 1; // cambiarlo per test
/* ---------------------------------------- */

const levels = {
  1: { tentativi: 5, cifre: 5 },
  2: { tentativi: 4, cifre: 5 } // cifre sempre 5 per entrambi i livelli
};

const todayKey = () => new Date().toISOString().slice(0,10);
if (localStorage.getItem('playedDate') !== todayKey()) {
  localStorage.setItem('playedDate', todayKey());
  localStorage.setItem('partiteOggi', '0');
}
let partiteOggi = parseInt(localStorage.getItem('partiteOggi') || '0');
if (partiteOggi >= maxPartiteGiornaliere){
  document.body.innerHTML = '<h2 style="padding:20px;">per oggi pu√≤ bastare, torna domani!</h2>';
  throw new Error('Partite giornaliere esaurite');
}

/* stato di gioco globale (usato da processKey) */
const current = {
  lvl: 1,
  tentativi: 0,
  cifre: 0,
  secret: '',
  tentativo: 0,
  currentCol: 0,
  active: false
};

/* helper: genera numero segreto */
function generateSecret(len){
  let s = '';
  for (let i=0;i<len;i++) s += Math.floor(Math.random()*10);
  return s;
}

/* costruisce la griglia per il livello corrente e imposta stato */
function startLevel(lvl){
  current.lvl = lvl;
  const cfg = levels[lvl];
  current.tentativi = cfg.tentativi;
  current.cifre = cfg.cifre;
  current.secret = generateSecret(cfg.cifre);
  current.tentativo = 0;
  current.currentCol = 0;
  current.active = true;

  // UI
  document.getElementById('levelIndicator').textContent = `üé≤ Livello ${lvl}`;
  document.getElementById('result').innerHTML = '';
  document.getElementById('statsBox').style.display = 'none';

  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = `repeat(${current.cifre}, ${getComputedStyle(document.documentElement).getPropertyValue('--cell-size') || '60px'})`;
  grid.style.gridTemplateRows = `repeat(${current.tentativi}, ${getComputedStyle(document.documentElement).getPropertyValue('--cell-size') || '60px'})`;

  for (let r = 0; r < current.tentativi; r++){
    for (let c = 0; c < current.cifre; c++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.id = `cell-${r}-${c}`;
      grid.appendChild(cell);
    }
  }
  updateActive();
}

/* evidenzia la cella corrente */
function updateActive(){
  document.querySelectorAll('.cell').forEach(el => el.classList.remove('active'));
  if (!current.active) return;
  if (current.tentativo < current.tentativi && current.currentCol < current.cifre){
    const el = document.getElementById(`cell-${current.tentativo}-${current.currentCol}`);
    if (el) el.classList.add('active');
  }
}

/* logica di controllo tentativo con regola duplicati corretta */
function checkAttempt(guess, row, secret){
  // conta occorrenze nel segreto
  const countSecret = {};
  for (let ch of secret) countSecret[ch] = (countSecret[ch]||0) + 1;

  const result = Array(current.cifre).fill(null);

  // primi verdi
  for (let i=0;i<current.cifre;i++){
    if (guess[i] === secret[i]) {
      result[i] = 'green';
      countSecret[guess[i]]--;
    }
  }
  // poi gialli/grigi
  for (let i=0;i<current.cifre;i++){
    const cell = document.getElementById(`cell-${row}-${i}`);
    if (!cell) continue;
    if (result[i] === 'green') { cell.style.background = '#6aaa64'; continue; }
    const ch = guess[i] || '';
    if (countSecret[ch] > 0) {
      result[i] = 'yellow';
      cell.style.background = '#c9b458';
      countSecret[ch]--;
    } else {
      result[i] = 'gray';
      cell.style.background = '#d3d3d3';
    }
  }
}

/* PROCESS KEY: chiamata sia da tastiera fisica sia dal tastierino */
function processKey(key){
  if (!current.active) return;

  // Numeri
  if (/^[0-9]$/.test(key)){
    if (current.currentCol < current.cifre){
      const cell = document.getElementById(`cell-${current.tentativo}-${current.currentCol}`);
      if (cell) cell.textContent = key;
      current.currentCol++;
      updateActive();
    }
    return;
  }

  // Backspace
  if (key === 'Backspace'){
    if (current.currentCol > 0){
      current.currentCol--;
      const cell = document.getElementById(`cell-${current.tentativo}-${current.currentCol}`);
      if (cell) cell.textContent = '';
      updateActive();
    }
    return;
  }

  // Enter => invia tentativo
  if (key === 'Enter'){
    if (current.currentCol !== current.cifre) return; // non completo
    const guessArr = [];
    for (let i=0;i<current.cifre;i++){
      const cell = document.getElementById(`cell-${current.tentativo}-${i}`);
      guessArr.push(cell ? (cell.textContent || '') : '');
    }
    const guessStr = guessArr.join('');
    checkAttempt(guessStr, current.tentativo, current.secret);

    // se vinto
    if (guessStr === current.secret){
      // se siamo a livello 1 ‚Üí avvia livello 2; se siamo a livello 2 ‚Üí vittoria totale
      if (current.lvl === 1){
        // small delay per far vedere colore prima di cambiare livello
        current.active = false;
        setTimeout(()=> startLevel(2), 450);
      } else {
        current.active = false;
        setTimeout(()=> endGame('Hai completato tutti i livelli!', current.tentativo + 1, current.lvl, true), 450);
      }
      return;
    }

    // non vinto: passa al tentativo successivo
    current.tentativo++;
    current.currentCol = 0;
    updateActive();

    if (current.tentativo >= current.tentativi){
      current.active = false;
      setTimeout(()=> endGame(`Tentativi terminati! Il numero era ${current.secret}`, current.tentativo, current.lvl, false), 450);
    }
    return;
  }
}

/* ENDGAME: aggiorna statistiche e mostra messaggio (vittoria contata solo se lvl===2 e vittoria===true) */
function endGame(msg, tentativiUsati = null, lvl = 1, vittoria = false){
  // aggiorna partite oggi
  let partiteOggi = parseInt(localStorage.getItem('partiteOggi') || '0');
  partiteOggi++;
  localStorage.setItem('partiteOggi', String(partiteOggi));

  // stats globali
  let stats = JSON.parse(localStorage.getItem('stats') || '{}');
  stats.partite = (stats.partite || 0) + 1;

  // conteggia vittorie solo se si supera il livello 2 (vittoria === true e lvl===2)
  if (vittoria && lvl === 2){
    stats.vittorie = (stats.vittorie || 0) + 1;
  }

  localStorage.setItem('stats', JSON.stringify(stats));

  // mostra messaggio e statistiche
  document.getElementById('result').innerHTML = `<h2>${msg}</h2>`;
  const statsBox = document.getElementById('statsBox');
  const totalGames = stats.partite || 0;
  const totalWins = stats.vittorie || 0;
  document.getElementById('statsSummary').textContent = `Partite giocateüïπÔ∏è: ${totalGames} ‚Äî Partite vinteüèÜ: ${totalWins}`;
  statsBox.style.display = 'block';

  // disattiva input
  current.active = false;
  // evidenzia griglia come disabilitata
  document.querySelectorAll('.cell').forEach(c => c.classList.add('disabled'));

  // mostra scritta "torna domani" se esaurite le partite
  if (parseInt(localStorage.getItem('partiteOggi') || '0') >= maxPartiteGiornaliere){
    const note = document.createElement('div');
    note.style.marginTop = '8px';
    note.style.color = '#555';
    note.textContent = 'Hai usato le partite di oggi ‚Äî torna domani per giocare ancora.';
    statsBox.appendChild(note);
  }
}

/* listener tastiera fisica (una sola volta) */
window.addEventListener('keydown', (ev) => {
  // preveniamo comportamenti indesiderati quando input focus √® su campi esterni
  const tag = (document.activeElement && document.activeElement.tagName) || '';
  if (tag === 'INPUT' || tag === 'TEXTAREA') return;
  processKey(ev.key);
});

/* setup tastierino numerico (bottone) */
function setupKeypad(){
  document.querySelectorAll('#keypad .key').forEach(btn => {
    btn.addEventListener('click', ()=> {
      const v = btn.textContent.trim();
      if (/^[0-9]$/.test(v)) processKey(v);
      // delete handled below
    });
  });
  const del = document.getElementById('delKey');
  if (del) del.addEventListener('click', ()=> processKey('Backspace'));
  // tasto INVIO del tastierino
  const enter = document.getElementById('enterKey');
  if (enter) enter.addEventListener('click', () => processKey('Enter'));
}
setupKeypad();

/* avvia gioco (livello 1) */
startLevel(1);

</script>
</body>
</html>

